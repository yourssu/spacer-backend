name: Validate Naming Convention

on:
  issues:
    types: [opened, edited]
  pull_request:
    types: [opened, edited, synchronize]
  push:
    branches-ignore:
      - main

jobs:
  validate-issue:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Read configuration
        id: config
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const yaml = require('js-yaml');

            try {
              // YAML íŒŒì¼ ì½ê¸°
              const configPath = '.github/naming-convention.yml';
              const fileContent = fs.readFileSync(configPath, 'utf8');
              const config = yaml.load(fileContent);
            
              // ì„¤ì •ì„ outputsë¡œ ì €ì¥
              core.setOutput('tags', config.tags.allowed.join('|'));
              core.setOutput('issue_pattern', config.patterns.issue_title);
              core.setOutput('enforce_issue', config.validation.issue.enforce);
              core.setOutput('comment_on_error', config.validation.issue.comment_on_error);
              core.setOutput('issue_error_msg', config.messages.issue_title_error);
            
              return config;
            } catch (error) {
              console.log('ì„¤ì • íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.');
            
              // ê¸°ë³¸ê°’ ì„¤ì •
              core.setOutput('tags', 'feat|fix|refactor|docs|chore|test|style|perf|build|ci|revert');
              core.setOutput('issue_pattern', '^({tags}):\\s.+');
              core.setOutput('enforce_issue', 'true');
              core.setOutput('comment_on_error', 'true');
              core.setOutput('issue_error_msg', 'âŒ ì´ìŠˆ ì œëª©ì´ í˜•ì‹ì„ ë”°ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            
              return null;
            }

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install js-yaml
        run: npm install js-yaml

      - name: Validate issue title
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const yaml = require('js-yaml');
            const fs = require('fs');

            let config;
            try {
              const configPath = '.github/naming-convention.yml';
              const fileContent = fs.readFileSync(configPath, 'utf8');
              config = yaml.load(fileContent);
            } catch (error) {
              // ê¸°ë³¸ ì„¤ì • ì‚¬ìš©
              config = {
                tags: {
                  allowed: ['feat', 'fix', 'refactor', 'docs', 'chore', 'test', 'style', 'perf', 'build', 'ci', 'revert']
                },
                patterns: {
                  issue_title: '^({tags}):\\s.+'
                },
                validation: {
                  issue: {
                    enforce: true,
                    comment_on_error: true
                  }
                },
                messages: {
                  issue_title_error: `âŒ **ì´ìŠˆ ì œëª© í˜•ì‹ ì˜¤ë¥˜**
            
                  ì˜¬ë°”ë¥¸ í˜•ì‹: \`<tag>: <description>\`
            
                  **ì˜ˆì‹œ:**
                  - \`feat: ì‚¬ìš©ì ë¡œê·¸ì¸ ê¸°ëŠ¥ ì¶”ê°€\`
                  - \`fix: ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë¬¸ì œ í•´ê²°\``
                }
              };
            }

            const issueTitle = context.payload.issue.title;
            const allowedTags = config.tags.allowed.join('|');
            const patternString = config.patterns.issue_title.replace('{tags}', allowedTags);
            const pattern = new RegExp(patternString);

            if (!pattern.test(issueTitle)) {
              let errorMessage = config.messages.issue_title_error;
            
              // í˜„ì¬ ì œëª© ì¶”ê°€
              errorMessage = `${errorMessage}\n\n**í˜„ì¬ ì œëª©:** \`${issueTitle}\``;
            
              // í—ˆìš©ë˜ëŠ” íƒœê·¸ ëª©ë¡ ì¶”ê°€
              errorMessage += '\n\n**í—ˆìš©ë˜ëŠ” íƒœê·¸:**\n';
              config.tags.allowed.forEach(tag => {
                errorMessage += `- \`${tag}\`\n`;
              });
            
              if (config.validation.issue.comment_on_error) {
                // ì´ìŠˆì— ì½”ë©˜íŠ¸ ì¶”ê°€
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: errorMessage
                });
              }
            
              if (config.validation.issue.enforce) {
                core.setFailed(`ì´ìŠˆ ì œëª©ì´ ì»¨ë²¤ì…˜ì„ ë”°ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤: ${issueTitle}`);
              }
            } else {
              console.log(`âœ… ì´ìŠˆ ì œëª© ê²€ì¦ í†µê³¼: ${issueTitle}`);
            }

  validate-pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install js-yaml
        run: npm install js-yaml

      - name: Validate PR title
        id: pr-title
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const yaml = require('js-yaml');
            const fs = require('fs');

            let config;
            try {
              const configPath = '.github/naming-convention.yml';
              const fileContent = fs.readFileSync(configPath, 'utf8');
              config = yaml.load(fileContent);
            } catch (error) {
              // ê¸°ë³¸ ì„¤ì •
              config = {
                tags: {
                  allowed: ['feat', 'fix', 'refactor', 'docs', 'chore', 'test', 'style', 'perf', 'build', 'ci', 'revert']
                },
                patterns: {
                  pr_title: '^\\[#\\d+\\];\\s({tags}):\\s.+'
                },
                validation: {
                  pull_request: {
                    enforce_title: true
                  }
                },
                messages: {
                  pr_title_error: `âŒ **PR ì œëª© í˜•ì‹ ì˜¤ë¥˜**`
                }
              };
            }

            const prTitle = context.payload.pull_request.title;
            const allowedTags = config.tags.allowed.join('|');
            const patternString = config.patterns.pr_title.replace('{tags}', allowedTags);
            const pattern = new RegExp(patternString);

            if (!pattern.test(prTitle)) {
              let errorMessage = config.messages.pr_title_error;
              errorMessage += `\n\n**í˜„ì¬ ì œëª©:** \`${prTitle}\``;
              errorMessage += `\n\n**ì˜¬ë°”ë¥¸ í˜•ì‹:** \`[#ì´ìŠˆë²ˆí˜¸]; <tag>: <description>\``;
              errorMessage += '\n\n**ì˜ˆì‹œ:**\n- `[#123]; feat: ì‚¬ìš©ì ì¸ì¦ API ì¶”ê°€`\n- `[#456]; fix: null pointer exception í•´ê²°`';
            
              if (config.validation.pull_request.enforce_title) {
                core.setFailed(`PR ì œëª©ì´ ì»¨ë²¤ì…˜ì„ ë”°ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤: ${prTitle}`);
              }
              core.setOutput('error', errorMessage);
              return false;
            } else {
              console.log(`âœ… PR ì œëª© ê²€ì¦ í†µê³¼: ${prTitle}`);
              return true;
            }

      - name: Validate branch name
        id: branch-name
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const yaml = require('js-yaml');
            const fs = require('fs');

            let config;
            try {
              const configPath = '.github/naming-convention.yml';
              const fileContent = fs.readFileSync(configPath, 'utf8');
              config = yaml.load(fileContent);
            } catch (error) {
              config = {
                tags: {
                  allowed: ['feat', 'fix', 'refactor', 'docs', 'chore', 'test', 'style', 'perf', 'build', 'ci', 'revert']
                },
                patterns: {
                  branch_name: '^({tags})/\\d+$'
                },
                validation: {
                  pull_request: {
                    enforce_branch: true
                  }
                },
                messages: {
                  branch_name_error: `âŒ **ë¸Œëœì¹˜ëª… í˜•ì‹ ì˜¤ë¥˜**`
                }
              };
            }

            const branchName = context.payload.pull_request.head.ref;
            const allowedTags = config.tags.allowed.join('|');
            const patternString = config.patterns.branch_name.replace('{tags}', allowedTags);
            const pattern = new RegExp(patternString);

            if (!pattern.test(branchName)) {
              let errorMessage = config.messages.branch_name_error;
              errorMessage += `\n\n**í˜„ì¬ ë¸Œëœì¹˜:** \`${branchName}\``;
              errorMessage += `\n\n**ì˜¬ë°”ë¥¸ í˜•ì‹:** \`<tag>/<ì´ìŠˆë²ˆí˜¸>\``;
              errorMessage += '\n\n**ì˜ˆì‹œ:**\n- `feat/123`\n- `fix/456`\n- `chore/789`';
            
              if (config.validation.pull_request.enforce_branch) {
                core.setFailed(`ë¸Œëœì¹˜ëª…ì´ ì»¨ë²¤ì…˜ì„ ë”°ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤: ${branchName}`);
              }
              core.setOutput('error', errorMessage);
              return false;
            } else {
              console.log(`âœ… ë¸Œëœì¹˜ëª… ê²€ì¦ í†µê³¼: ${branchName}`);
              return true;
            }

      - name: Get commit messages
        id: commits
        run: |
          # PRì˜ ëª¨ë“  ì»¤ë°‹ ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸°
          COMMITS=$(git log --format=%s origin/${{ github.base_ref }}..HEAD 2>/dev/null || echo "")
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Validate commit messages
        id: commit-messages
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const yaml = require('js-yaml');
            const fs = require('fs');

            let config;
            try {
              const configPath = '.github/naming-convention.yml';
              const fileContent = fs.readFileSync(configPath, 'utf8');
              config = yaml.load(fileContent);
            } catch (error) {
              config = {
                tags: {
                  allowed: ['feat', 'fix', 'refactor', 'docs', 'chore', 'test', 'style', 'perf', 'build', 'ci', 'revert']
                },
                patterns: {
                  commit_message: '^\\[#\\d+\\];\\s({tags}):\\s.+'
                },
                validation: {
                  pull_request: {
                    enforce_commits: false
                  }
                },
                messages: {
                  commit_message_warning: `âš ï¸ **ì»¤ë°‹ ë©”ì‹œì§€ í˜•ì‹ ê²½ê³ **`
                }
              };
            }

            const commits = `${{ steps.commits.outputs.commits }}`.trim().split('\n').filter(c => c);
            const allowedTags = config.tags.allowed.join('|');
            const patternString = config.patterns.commit_message.replace('{tags}', allowedTags);
            const pattern = new RegExp(patternString);

            let invalidCommits = [];
            let validCount = 0;

            for (const commit of commits) {
              if (commit && !pattern.test(commit)) {
                invalidCommits.push(commit);
              } else if (commit) {
                validCount++;
              }
            }

            if (invalidCommits.length > 0) {
              let warningMessage = config.messages.commit_message_warning;
              warningMessage += '\n\nì¼ë¶€ ì»¤ë°‹ì´ ì»¨ë²¤ì…˜ì„ ë”°ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤:\n';
              warningMessage += invalidCommits.map(c => `- \`${c}\``).join('\n');
              warningMessage += '\n\n**ì˜¬ë°”ë¥¸ í˜•ì‹:** `[#ì´ìŠˆë²ˆí˜¸]; <tag>: <description>`';
              warningMessage += '\n\n**ì˜ˆì‹œ:**\n- `[#123]; feat: ì‚¬ìš©ì ì¸ì¦ API ì¶”ê°€`\n- `[#123]; fix: null ì²´í¬ ì¶”ê°€`';
            
              if (!config.validation.pull_request.enforce_commits) {
                warningMessage += '\n\nâ„¹ï¸ ì´ëŠ” ê²½ê³ ì´ë©°, PR ë³‘í•©ì„ ë§‰ì§€ëŠ” ì•ŠìŠµë‹ˆë‹¤.';
                console.log(`âš ï¸ ${invalidCommits.length}ê°œì˜ ì»¤ë°‹ì´ ì»¨ë²¤ì…˜ì„ ë”°ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤`);
              } else {
                core.setFailed(`ì»¤ë°‹ ë©”ì‹œì§€ê°€ ì»¨ë²¤ì…˜ì„ ë”°ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤`);
              }
            
              core.setOutput('warning', warningMessage);
              return false;
            } else {
              console.log(`âœ… ëª¨ë“  ì»¤ë°‹ ë©”ì‹œì§€ ê²€ì¦ í†µê³¼ (${validCount}ê°œ)`);
              return true;
            }

      - name: Post validation results
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const yaml = require('js-yaml');
            const fs = require('fs');

            let config;
            try {
              const configPath = '.github/naming-convention.yml';
              const fileContent = fs.readFileSync(configPath, 'utf8');
              config = yaml.load(fileContent);
            } catch (error) {
              config = {
                validation: {
                  pull_request: {
                    comment_on_error: true
                  }
                }
              };
            }

            if (!config.validation.pull_request.comment_on_error) {
              console.log('ì½”ë©˜íŠ¸ ê¸°ëŠ¥ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
              return;
            }

            const prTitleError = '${{ steps.pr-title.outputs.error }}';
            const branchError = '${{ steps.branch-name.outputs.error }}';
            const commitWarning = '${{ steps.commit-messages.outputs.warning }}';

            let comment = '## ğŸ“‹ ë„¤ì´ë° ì»¨ë²¤ì…˜ ê²€ì¦ ê²°ê³¼\n\n';

            // PR ì œëª© ê²€ì¦ ê²°ê³¼
            if (prTitleError) {
              comment += prTitleError + '\n\n';
            } else {
              comment += 'âœ… **PR ì œëª©**: í†µê³¼\n\n';
            }

            // ë¸Œëœì¹˜ëª… ê²€ì¦ ê²°ê³¼
            if (branchError) {
              comment += branchError + '\n\n';
            } else {
              comment += 'âœ… **ë¸Œëœì¹˜ëª…**: í†µê³¼\n\n';
            }

            // ì»¤ë°‹ ë©”ì‹œì§€ ê²€ì¦ ê²°ê³¼
            if (commitWarning) {
              comment += commitWarning + '\n\n';
            } else {
              comment += 'âœ… **ì»¤ë°‹ ë©”ì‹œì§€**: ëª¨ë‘ í†µê³¼\n\n';
            }

            // ì„¤ì • íŒŒì¼ ì •ë³´
            comment += '\n---\n';
            comment += '_ì„¤ì • íŒŒì¼: `.github/naming-convention.yml`_';

            // ê¸°ì¡´ ë´‡ ì½”ë©˜íŠ¸ ì°¾ê¸°
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo
            });

            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ë„¤ì´ë° ì»¨ë²¤ì…˜ ê²€ì¦ ê²°ê³¼')
            );

            if (botComment) {
              // ê¸°ì¡´ ì½”ë©˜íŠ¸ ì—…ë°ì´íŠ¸
              await github.rest.issues.updateComment({
                comment_id: botComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } else {
              // ìƒˆ ì½”ë©˜íŠ¸ ìƒì„±
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

  validate-push:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install js-yaml
        run: npm install js-yaml

      - name: Validate commit messages in push
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const yaml = require('js-yaml');
            const fs = require('fs');

            let config;
            try {
              const configPath = '.github/naming-convention.yml';
              const fileContent = fs.readFileSync(configPath, 'utf8');
              config = yaml.load(fileContent);
            } catch (error) {
              config = {
                tags: {
                  allowed: ['feat', 'fix', 'refactor', 'docs', 'chore', 'test', 'style', 'perf', 'build', 'ci', 'revert']
                },
                patterns: {
                  commit_message: '^\\[#\\d+\\];\\s({tags}):\\s.+'
                },
                validation: {
                  push: {
                    enforce: false
                  }
                }
              };
            }

            const allowedTags = config.tags.allowed.join('|');
            const patternString = config.patterns.commit_message.replace('{tags}', allowedTags);
            const pattern = new RegExp(patternString);

            let hasInvalidCommit = false;

            for (const commit of context.payload.commits) {
              const message = commit.message.split('\n')[0]; // ì²« ì¤„ë§Œ ê²€ì¦
            
              if (!pattern.test(message)) {
                console.log(`âš ï¸ ì»¤ë°‹ ë©”ì‹œì§€ê°€ ì»¨ë²¤ì…˜ì„ ë”°ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤: ${message}`);
                hasInvalidCommit = true;
              } else {
                console.log(`âœ… ì»¤ë°‹ ë©”ì‹œì§€ ê²€ì¦ í†µê³¼: ${message}`);
              }
            }

            if (hasInvalidCommit) {
              console.log('\nâš ï¸ ì¼ë¶€ ì»¤ë°‹ì´ ë„¤ì´ë° ì»¨ë²¤ì…˜ì„ ë”°ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
              console.log('ì˜¬ë°”ë¥¸ í˜•ì‹: [#ì´ìŠˆë²ˆí˜¸]; <tag>: <description>');
            
              if (config.validation.push.enforce) {
                core.setFailed('ì»¤ë°‹ ë©”ì‹œì§€ê°€ ì»¨ë²¤ì…˜ì„ ë”°ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
              }
            }